<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚öõÔ∏è ELEMENTRON - Juego Qu√≠mico</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%);
      color: white;
      overflow: hidden;
    }
    .container { display: flex; height: 100vh; flex-direction: row; }
    .game-area { 
      flex: 1; 
      display: flex; 
      flex-direction: column;
      align-items: center; 
      justify-content: center; 
      padding: 20px; 
      position: relative; 
    }
    
    .target-banner {
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      border: 3px solid #60a5fa;
      border-radius: 15px;
      padding: 15px 30px;
      margin-bottom: 20px;
      box-shadow: 0 0 30px rgba(59, 130, 246, 0.6);
      animation: bannerPulse 2s ease-in-out infinite;
      text-align: center;
      min-width: 400px;
    }
    
    @keyframes bannerPulse {
      0%, 100% { 
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.6);
        transform: scale(1);
      }
      50% { 
        box-shadow: 0 0 40px rgba(96, 165, 250, 0.8);
        transform: scale(1.02);
      }
    }
    
    .target-banner-label {
      font-size: 1rem;
      color: #93c5fd;
      margin-bottom: 8px;
      letter-spacing: 2px;
      font-weight: bold;
    }
    
    .target-banner-element {
      font-size: 2.5rem;
      font-weight: 900;
      color: #fbbf24;
      text-shadow: 0 0 15px rgba(251, 191, 36, 0.8);
      letter-spacing: 3px;
    }
    
    canvas { 
      background-color: #1f2937; 
      display: block; 
      border: 2px solid #374151; 
      touch-action: none; 
    }
    
    .sidebar {
      width: 320px;
      background-color: #1f2937;
      padding: 20px;
      border-left: 4px solid #374151;
      overflow-y: auto;
      flex-shrink: 0;
    }
    @media (max-width: 768px) {
      .container { flex-direction: column; }
      .sidebar { width: 100%; max-height: 30vh; border-left: none; border-top: 4px solid #374151; }
      .game-area { padding: 10px; }
      .target-banner { min-width: 300px; padding: 10px 20px; }
      .target-banner-element { font-size: 2rem; }
    }
    .sidebar h2 { font-size: 1.25rem; margin-bottom: 20px; color: #60a5fa; }
    .info-box { margin-bottom: 15px; padding: 12px; background-color: #374151; border-radius: 8px; }
    .info-box strong { color: #60a5fa; }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: bold;
      margin-top: 5px;
    }
    .badge-metal { background-color: #6b7280; color: white; }
    .badge-nometal { background-color: #10b981; color: white; }
    .badge-anfotero { background-color: #3b82f6; color: white; }
    .modal {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 27, 75, 0.95) 50%, rgba(49, 46, 129, 0.95) 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    .modal.hidden { display: none; }
    .menu-animated { animation: fadeIn 0.8s ease-in; }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    .logo-container { text-align: center; margin-bottom: 30px; }
    .atom-icon {
      font-size: 5rem;
      animation: rotate 4s linear infinite;
      display: inline-block;
    }
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .title-main {
      font-size: 5rem;
      font-weight: 900;
      background: linear-gradient(45deg, #60a5fa, #a78bfa, #ec4899, #f59e0b);
      background-size: 300% 300%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: gradientShift 3s ease infinite;
      letter-spacing: 8px;
      margin: 20px 0 10px 0;
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .subtitle {
      font-size: 1.2rem;
      color: #93c5fd;
      margin-bottom: 10px;
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 1; }
    }
    .school-name {
      font-size: 0.9rem;
      color: #cbd5e1;
      margin-bottom: 40px;
      letter-spacing: 2px;
    }
    .menu-form { display: flex; flex-direction: column; gap: 15px; align-items: center; }
    .input-animated, .select-animated {
      width: 350px;
      padding: 15px 20px;
      font-size: 1.1rem;
      border: 2px solid #3b82f6;
      border-radius: 12px;
      background: rgba(30, 41, 59, 0.8);
      color: white;
      transition: all 0.3s ease;
    }
    .input-animated:focus, .select-animated:focus {
      outline: none;
      border-color: #60a5fa;
      box-shadow: 0 0 20px rgba(96, 165, 250, 0.5);
      transform: scale(1.02);
    }
    .select-animated option { background: #1e293b; color: white; }
    .btn-glow {
      animation: glow 2s ease-in-out infinite;
      font-size: 1.2rem;
      padding: 15px 40px;
      width: 350px;
    }
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 20px rgba(37, 99, 235, 0.5); }
      50% { box-shadow: 0 0 40px rgba(37, 99, 235, 0.8), 0 0 60px rgba(96, 165, 250, 0.6); }
    }
    .modal h1 { font-size: 3rem; margin-bottom: 20px; }
    .modal button {
      padding: 12px 24px;
      margin: 10px;
      font-size: 1rem;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-primary { background-color: #2563eb; color: white; }
    .btn-primary:hover { background-color: #1d4ed8; }
    .btn-danger { background-color: #dc2626; color: white; }
    .btn-danger:hover { background-color: #b91c1c; }
    .btn-success { background-color: #16a34a; color: white; }
    .btn-success:hover { background-color: #15803d; }
    .btn-secondary { background-color: #6b7280; color: white; }
    .btn-secondary:hover { background-color: #4b5563; }
    .score-display { font-size: 1.5rem; color: #fbbf24; margin: 10px 0; }
    .target-box {
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%) !important;
      border: 3px solid #60a5fa;
      animation: pulse-glow 2s ease-in-out infinite;
    }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
      50% { box-shadow: 0 0 25px rgba(96, 165, 250, 0.8); }
    }
    .target-element {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 10px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    }
    .target-sim {
      font-size: 2.5rem;
      font-weight: bold;
      color: #fbbf24;
      text-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
    }
    .target-name { font-size: 1.1rem; color: #e0e7ff; margin: 5px 0; }
    .target-valencia {
      font-size: 0.9rem;
      color: #cbd5e1;
      background: rgba(0, 0, 0, 0.3);
      padding: 4px 8px;
      border-radius: 4px;
      margin-top: 5px;
    }
    .periodic-table-box { max-height: 200px; overflow-y: auto; }
    .mini-table {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
      gap: 4px;
      margin-top: 10px;
    }
    .element-cell {
      padding: 8px 4px;
      text-align: center;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
      word-wrap: break-word;
    }
    .element-cell.eaten { opacity: 0.3; text-decoration: line-through; }
    .element-cell.current {
      border: 2px solid #fbbf24;
      animation: blink 1s ease-in-out infinite;
      transform: scale(1.1);
    }
    @keyframes blink {
      0%, 100% { border-color: #fbbf24; }
      50% { border-color: #f59e0b; }
    }
    .error-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #dc2626;
      color: white;
      padding: 30px 50px;
      border-radius: 15px;
      font-size: 1.5rem;
      font-weight: bold;
      z-index: 100;
      box-shadow: 0 0 50px rgba(220, 38, 38, 0.8);
      animation: errorPop 0.5s ease-out;
    }
    @keyframes errorPop {
      0% { transform: translate(-50%, -50%) scale(0); }
      50% { transform: translate(-50%, -50%) scale(1.1); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }
    .game-over-container {
      text-align: center;
      position: relative;
      animation: gameOverSlide 1s ease-out;
    }
    @keyframes gameOverSlide {
      0% { opacity: 0; transform: translateY(-100px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .explosion-effect {
      font-size: 8rem;
      animation: explode 1s ease-out;
      margin-bottom: 20px;
    }
    @keyframes explode {
      0% { transform: scale(0) rotate(0deg); opacity: 0; }
      50% { transform: scale(1.5) rotate(180deg); opacity: 1; }
      100% { transform: scale(1) rotate(360deg); opacity: 1; }
    }
    .game-over-title {
      font-size: 4rem;
      color: #ef4444;
      text-shadow: 0 0 20px rgba(239, 68, 68, 0.8);
      animation: flicker 2s ease-in-out infinite;
      margin-bottom: 10px;
    }
    @keyframes flicker {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .game-over-subtitle {
      font-size: 1.3rem;
      color: #fca5a5;
      margin-bottom: 40px;
      animation: fadeInUp 1s ease-out 0.3s both;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .stats-container {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin: 30px 0;
      animation: fadeInUp 1s ease-out 0.5s both;
    }
    .stat-card {
      background: rgba(31, 41, 59, 0.8);
      border: 2px solid #374151;
      border-radius: 15px;
      padding: 20px;
      min-width: 150px;
      transition: all 0.3s;
    }
    .stat-card:hover {
      transform: translateY(-5px);
      border-color: #60a5fa;
      box-shadow: 0 10px 30px rgba(96, 165, 250, 0.3);
    }
    .stat-icon { font-size: 3rem; margin-bottom: 10px; }
    .stat-label { font-size: 0.9rem; color: #94a3b8; margin-bottom: 8px; }
    .stat-value { font-size: 2rem; font-weight: bold; color: #fbbf24; }
    .death-cause { font-size: 1.2rem !important; color: #ef4444 !important; }
    .game-over-message {
      background: rgba(59, 130, 246, 0.2);
      border-left: 4px solid #3b82f6;
      padding: 20px;
      margin: 30px auto;
      max-width: 600px;
      border-radius: 10px;
      font-style: italic;
      color: #cbd5e1;
      animation: fadeInUp 1s ease-out 0.7s both;
    }
    .btn-pulse { animation: btnPulse 2s ease-in-out infinite; }
    @keyframes btnPulse {
      0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(220, 38, 38, 0.5); }
      50% { transform: scale(1.05); box-shadow: 0 0 40px rgba(220, 38, 38, 0.8), 0 0 60px rgba(239, 68, 68, 0.6); }
    }
    .audio-controls {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
      z-index: 1000;
    }
    .audio-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      background: rgba(37, 99, 235, 0.8);
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .audio-btn:hover { background: rgba(37, 99, 235, 1); transform: scale(1.1); }
    .audio-btn.muted { background: rgba(220, 38, 38, 0.8); }
    .touch-indicator {
      position: absolute;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: rgba(96, 165, 250, 0.3);
      border: 3px solid rgba(96, 165, 250, 0.6);
      pointer-events: none;
      transform: translate(-50%, -50%);
      animation: touchPulse 0.5s ease-out;
      z-index: 100;
    }
    @keyframes touchPulse {
      0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
    }
    .button-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <div id="menuScreen" class="modal menu-animated">
    <div class="logo-container">
      <div class="atom-icon">‚öõÔ∏è</div>
      <h1 class="title-main">ELEMENTRON</h1>
      <p class="subtitle">El juego de la serpiente qu√≠mica</p>
    </div>
    <div class="school-name">U.E.T.H.E. 25 DE JULIO B</div>
    <div class="menu-form">
      <input type="text" id="playerNameInput" placeholder="Ingresa tu nombre" class="input-animated" />
      <select id="categorySelect" class="select-animated">
        <option value="metales">üî© Metales</option>
        <option value="noMetales">üí® No Metales</option>
        <option value="anfoteros">‚ö° Anf√≥teros</option>
        <option value="todos">üåü Todos (mixto)</option>
      </select>
      <button class="btn-primary btn-glow" id="startGameBtn">üöÄ Iniciar Juego</button>
    </div>
  </div>

  <div id="gameOverScreen" class="modal hidden">
    <div class="game-over-container">
      <div class="explosion-effect">üí•</div>
      <h1 class="game-over-title">‚ò†Ô∏è GAME OVER ‚ò†Ô∏è</h1>
      <div class="game-over-subtitle">¬°La serpiente qu√≠mica se desintegr√≥!</div>
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-icon">üèÜ</div>
          <div class="stat-label">Puntaje Final</div>
          <div class="stat-value" id="finalScore">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚öõÔ∏è</div>
          <div class="stat-label">Elementos Comidos</div>
          <div class="stat-value" id="elementsEaten">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üíÄ</div>
          <div class="stat-label">Causa de Muerte</div>
          <div class="stat-value death-cause" id="deathCause">Colisi√≥n</div>
        </div>
      </div>
      <div class="game-over-message" id="gameOverMessage"></div>
      <div class="button-group">
        <button class="btn-danger btn-pulse" id="retryBtn">üîÑ Reintentar</button>
        <button class="btn-secondary" id="menuBtn">üè† Volver al Inicio</button>
      </div>
    </div>
  </div>

  <div id="winScreen" class="modal hidden">
    <div class="game-over-container">
      <h1 style="color: #10b981;">üéâ ¬°VICTORIA! üéâ</h1>
      <p style="font-size: 1.2rem; margin: 10px 0;">¬°Comiste todos los elementos!</p>
      <p class="score-display">Puntaje final: <span id="winScore">0</span></p>
      <div class="button-group">
        <button class="btn-success" id="winRetryBtn">üîÑ Jugar de Nuevo</button>
        <button class="btn-secondary" id="winMenuBtn">üè† Volver al Inicio</button>
      </div>
    </div>
  </div>

  <div class="container" id="gameContainer" style="display: none;">
    <div class="game-area">
      <div class="target-banner" id="targetBanner">
        <div class="target-banner-label">üéØ ELEMENTO A COMER</div>
        <div class="target-banner-element" id="bannerElement">--</div>
      </div>
      
      <canvas id="gameCanvas" width="600" height="600"></canvas>
    </div>
    <div class="sidebar">
      <h2>üìä Informaci√≥n</h2>
      <div class="info-box"><strong>Jugador:</strong> <span id="playerDisplay">An√≥nimo</span></div>
      <div class="info-box"><strong>Categor√≠a:</strong> <span id="categoryDisplay">metales</span></div>
      <div class="info-box"><strong>Puntaje:</strong> <span id="scoreDisplay" style="color: #fbbf24;">0</span></div>
      <div class="info-box"><strong>Vidas:</strong> <span id="livesDisplay" style="color: #ef4444;">3</span></div>
      <div class="info-box"><strong>Restantes:</strong> <span id="remainingDisplay">0</span></div>
      <div id="targetElementBox" class="info-box target-box">
        <strong>üéØ Detalles del elemento:</strong><br>
        <div id="targetElementDisplay" class="target-element">
          <span class="target-sim">--</span>
          <span class="target-name">Esperando...</span>
          <span class="target-valencia">Valencia: --</span>
        </div>
      </div>
      <div class="info-box periodic-table-box">
        <strong>üìã Tabla de Elementos:</strong>
        <div id="periodicTable" class="mini-table"></div>
      </div>
      <div class="info-box">
        <strong>√öltimo elemento:</strong><br>
        <span id="lastElementDisplay" style="color: #9ca3af;">Ninguno</span>
      </div>
      <div class="info-box" style="background-color: #4b5563;">
        <strong>Controles:</strong><br>‚¨ÜÔ∏è ‚¨áÔ∏è ‚¨ÖÔ∏è ‚û°Ô∏è Flechas del teclado<br>üëÜ Desliza o toca en pantalla
      </div>
    </div>
  </div>

  <div class="audio-controls">
    <button class="audio-btn" id="muteBtn" title="Silenciar/Activar">üîä</button>
  </div>

</body>
</html>
<script>

class AudioManager {
  constructor() {
    this.ctx = null;
    this.isMuted = false;
    this.masterVolume = 0.3;
    this.speechEnabled = true;
    this.combo = 0;
    this.lastEatTime = 0;
    this.bgMusicPlaying = false;
  }
  init() {
    try {
      this.ctx = new (window.AudioContext || window.webkitAudioContext)();
    } catch (e) {
      console.log('Web Audio API no soportada');
    }
  }
  speak(text, rate = 1.3, pitch = 1.3) {
    if (this.isMuted || !this.speechEnabled) return;
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
      const cleanText = text.replace(/-/g, ' menos ').replace(/\+/g, ' m√°s ');
      const utterance = new SpeechSynthesisUtterance(cleanText);
      utterance.lang = 'es-ES';
      utterance.rate = rate;
      utterance.pitch = pitch;
      utterance.volume = this.masterVolume * 3;
      window.speechSynthesis.speak(utterance);
    }
  }
  playTone(frequency, duration, type = 'sine', volume = 0.3) {
    if (!this.ctx || this.isMuted) return;
    const oscillator = this.ctx.createOscillator();
    const gainNode = this.ctx.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(this.ctx.destination);
    oscillator.frequency.value = frequency;
    oscillator.type = type;
    gainNode.gain.setValueAtTime(volume * this.masterVolume, this.ctx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
    oscillator.start(this.ctx.currentTime);
    oscillator.stop(this.ctx.currentTime + duration);
  }
  playChord(frequencies, duration, type = 'sine', volume = 0.2) {
    frequencies.forEach(freq => {
      this.playTone(freq, duration, type, volume);
    });
  }
  playMenuMusic() {
    if (this.isMuted) return;
    const melody = [
      { notes: [523.25, 659.25], duration: 0.25 },
      { notes: [587.33, 698.46], duration: 0.25 },
      { notes: [659.25, 783.99], duration: 0.25 },
      { notes: [783.99, 987.77], duration: 0.5 }
    ];
    let time = 0;
    melody.forEach(item => {
      setTimeout(() => {
        if (this.isMuted) return;
        this.playChord(item.notes, item.duration, 'sine', 0.15);
      }, time * 1000);
      time += item.duration;
    });
  }
  playBackgroundMusic() {
    if (this.isMuted || this.bgMusicPlaying) return;
    this.bgMusicPlaying = true;
    
    const playLoop = () => {
      if (!this.bgMusicPlaying || this.isMuted) return;
      
      const suspensePattern = [
        { freq: 196, duration: 0.4, type: 'sine', vol: 0.08 },
        { freq: 220, duration: 0.4, type: 'sine', vol: 0.08 },
        { freq: 196, duration: 0.4, type: 'sine', vol: 0.08 },
        { freq: 174.61, duration: 0.6, type: 'sine', vol: 0.08 },
        { freq: 196, duration: 0.3, type: 'triangle', vol: 0.06 },
        { freq: 220, duration: 0.3, type: 'triangle', vol: 0.06 },
        { freq: 246.94, duration: 0.5, type: 'sine', vol: 0.08 },
        { freq: 220, duration: 0.5, type: 'sine', vol: 0.08 }
      ];
      
      let time = 0;
      suspensePattern.forEach(note => {
        setTimeout(() => {
          if (!this.bgMusicPlaying || this.isMuted) return;
          this.playTone(note.freq, note.duration, note.type, note.vol);
        }, time * 1000);
        time += note.duration;
      });
      
      setTimeout(() => {
        if (this.bgMusicPlaying) playLoop();
      }, time * 1000);
    };
    
    playLoop();
  }
  stopBackgroundMusic() {
    this.bgMusicPlaying = false;
  }
  playSuccess() {
    if (this.isMuted) return;
    const notes = [523.25, 659.25, 783.99, 1046.50];
    notes.forEach((freq, i) => {
      setTimeout(() => {
        this.playTone(freq, 0.15, 'sine', 0.25);
      }, i * 80);
    });
  }
  playError() {
    if (this.isMuted) return;
    this.playTone(200, 0.1, 'sawtooth', 0.4);
    setTimeout(() => this.playTone(150, 0.2, 'sawtooth', 0.4), 100);
  }
  playGameOver() {
    if (this.isMuted) return;
    const notes = [392, 370, 349, 330, 311, 294, 277, 262];
    notes.forEach((freq, i) => {
      setTimeout(() => {
        this.playTone(freq, 0.2, 'triangle', 0.3);
      }, i * 100);
    });
  }
  playVictory() {
    if (this.isMuted) return;
    const melody = [
      { freq: 523.25, duration: 0.2 },
      { freq: 659.25, duration: 0.2 },
      { freq: 783.99, duration: 0.3 },
      { freq: 1046.50, duration: 0.5 }
    ];
    melody.forEach((note, i) => {
      setTimeout(() => {
        this.playTone(note.freq, note.duration, 'sine', 0.3);
      }, i * 200);
    });
  }
  playEat() {
    if (this.isMuted) return;
    const now = Date.now();
    if (now - this.lastEatTime < 2000) {
      this.combo++;
    } else {
      this.combo = 1;
    }
    this.lastEatTime = now;
    const baseFreq = 800 + (this.combo * 50);
    this.playTone(baseFreq, 0.08, 'square', 0.25);
  }
  speakElement(element, isCorrect = true) {
    if (isCorrect) {
      this.playEat();
      const text = `${element.nombre}, ${element.sim}, valencia ${element.valencia}`;
      setTimeout(() => this.speak(text, 1.3, 1.4), 200);
    } else {
      this.playError();
      const text = `Incorrecto. ${element.nombre}`;
      setTimeout(() => this.speak(text, 1.0, 0.9), 200);
    }
  }
  toggleMute() {
    this.isMuted = !this.isMuted;
    const btn = document.getElementById('muteBtn');
    if (this.isMuted) {
      btn.textContent = 'üîá';
      btn.classList.add('muted');
      window.speechSynthesis.cancel();
      this.stopBackgroundMusic();
    } else {
      btn.textContent = 'üîä';
      btn.classList.remove('muted');
    }
    return this.isMuted;
  }
}

const audioManager = new AudioManager();
const elements = {
  metales: [
    {sim:"Li", nombre:"Litio", valencia:"+1"},
    {sim:"Na", nombre:"Sodio", valencia:"+1"},
    {sim:"K", nombre:"Potasio", valencia:"+1"},
    {sim:"Rb", nombre:"Rubidio", valencia:"+1"},
    {sim:"Cs", nombre:"Cesio", valencia:"+1"},
    {sim:"Fr", nombre:"Francio", valencia:"+1"},
    {sim:"NH4", nombre:"Amonio", valencia:"+1"},
    {sim:"Ag", nombre:"Plata", valencia:"+1"},
    {sim:"Ba", nombre:"Bario", valencia:"+2"},
    {sim:"Ra", nombre:"Radio", valencia:"+2"},
    {sim:"Ca", nombre:"Calcio", valencia:"+2"},
    {sim:"Mg", nombre:"Magnesio", valencia:"+2"},
    {sim:"Sr", nombre:"Estroncio", valencia:"+2"},
    {sim:"Be", nombre:"Berilio", valencia:"+2"},
    {sim:"Zn", nombre:"Zinc", valencia:"+2"},
    {sim:"Cd", nombre:"Cadmio", valencia:"+2"},
    {sim:"Al", nombre:"Aluminio", valencia:"+3"},
    {sim:"Ga", nombre:"Galio", valencia:"+3"},
    {sim:"In", nombre:"Indio", valencia:"+3"},
    {sim:"Y", nombre:"Ytrio", valencia:"+3"},
    {sim:"Cu", nombre:"Cobre", valencia:"+1,+2"},
    {sim:"Hg", nombre:"Mercurio", valencia:"+1,+2"},
    {sim:"Au", nombre:"Oro", valencia:"+1,+3"},
    {sim:"Tl", nombre:"Talio", valencia:"+1,+3"},
    {sim:"Fe", nombre:"Hierro", valencia:"+2,+3"},
    {sim:"Co", nombre:"Cobalto", valencia:"+2,+3"},
    {sim:"Ni", nombre:"Niquel", valencia:"+2,+3"},
    {sim:"Pb", nombre:"Plomo", valencia:"+2,+4"},
    {sim:"Pt", nombre:"Platino", valencia:"+2,+4"},
    {sim:"Sn", nombre:"Esta√±o", valencia:"+2,+4"},
    {sim:"Pd", nombre:"Paladio", valencia:"+2,+4"},
    {sim:"Ge", nombre:"Germanio", valencia:"+2,+4"}
  ],
  noMetales: [
    {sim:"F", nombre:"Fluor", valencia:"-1,+1,+3,+5,+7"},
    {sim:"Cl", nombre:"Cloro", valencia:"-1,+1,+3,+5,+7"},
    {sim:"Br", nombre:"Bromo", valencia:"-1,+1,+3,+5,+7"},
    {sim:"I", nombre:"Yodo", valencia:"-1,+1,+3,+5,+7"},
    {sim:"O", nombre:"Oxigeno", valencia:"-2,+2,+4,+6"},
    {sim:"S", nombre:"Azufre", valencia:"-2,+2,+4,+6"},
    {sim:"Se", nombre:"Selenio", valencia:"-2,+2,+4,+6"},
    {sim:"Te", nombre:"Telurio", valencia:"-2,+2,+4,+6"},
    {sim:"N", nombre:"Nitrogeno", valencia:"-3,+3,+5"},
    {sim:"P", nombre:"Fosforo", valencia:"-3,+3,+5"},
    {sim:"As", nombre:"Arsenico", valencia:"-3,+3,+5"},
    {sim:"Sb", nombre:"Antimonio", valencia:"-3,+3,+5"},
    {sim:"B", nombre:"Boro", valencia:"-3,+3"},
    {sim:"C", nombre:"Carbono", valencia:"-4,+2,+4"},
    {sim:"Si", nombre:"Silicio", valencia:"-4,+4"}
  ],
  anfoteros: [
    {sim:"Cr", nombre:"Cromo", valencia:"+2,+3,+6"},
    {sim:"Mn", nombre:"Manganeso", valencia:"+2,+3,+4,+6,+7"},
    {sim:"Mo", nombre:"Molibdeno", valencia:"+2,+3,+4,+5,+6"},
    {sim:"W", nombre:"Wolfran", valencia:"+2,+3,+4,+5,+6"},
    {sim:"V", nombre:"Vanadio", valencia:"+2,+3,+4,+5"},
    {sim:"Ti", nombre:"Titanio", valencia:"+2,+3+4"},
    {sim:"Ni", nombre:"Nitrogeno", valencia:"+1,+2,+4"},
    {sim:"Bi", nombre:"Bismuto", valencia:"+3,+5"},
    {sim:"U", nombre:"Uranio", valencia:"+3,+4,+5,+6"}
  ]
};

elements.todos = [...elements.metales, ...elements.noMetales, ...elements.anfoteros];

const game = {
  canvas: null,
  ctx: null,
  box: 20,
  snake: [],
  direction: null,
  foodItems: [],
  maxFoodItems: 12, 
  score: 0,
  lives: 3,
  availableElements: [],
  eatenElements: [],
  targetElement: null,
  gameInterval: null,
  gameState: 'menu',
  playerName: '',
  selectedCategory: 'metales',
  lastElement: null,
  deathCause: 'Colisi√≥n',
  gameColors: [
    '#ef4444', '#f59e0b', '#10b981', '#3b82f6', 
    '#8b5cf6', '#ec4899', '#06b6d4', '#14b8a6', 
    '#f97316', '#84cc16', '#a855f7', '#6366f1'
  ],
  elementColorMap: {},

  init() {
    this.canvas = document.getElementById('gameCanvas');
    this.ctx = this.canvas.getContext('2d');
    this.setupEventListeners();
    audioManager.init();
    audioManager.playMenuMusic();
  },

  setupEventListeners() {
    document.addEventListener('keydown', (e) => this.handleKeydown(e));
    
    this.canvas.addEventListener('touchstart', (e) => this.handleTouchStart(e), { passive: false });
    this.canvas.addEventListener('touchmove', (e) => this.handleTouchMove(e), { passive: false });
    this.canvas.addEventListener('touchend', (e) => this.handleTouchEnd(e), { passive: false });
    this.canvas.addEventListener('mousedown', (e) => this.handleMouseDown(e));
    
    this.touchStartX = 0;
    this.touchStartY = 0;
    this.touchEndX = 0;
    this.touchEndY = 0;
    this.minSwipeDistance = 30;
    
    document.getElementById('startGameBtn').addEventListener('click', () => {
      this.startGame();
    });
    
    document.getElementById('retryBtn').addEventListener('click', () => this.retryGame());
    document.getElementById('menuBtn').addEventListener('click', () => this.backToMenu());
    document.getElementById('winRetryBtn').addEventListener('click', () => this.retryGame());
    document.getElementById('winMenuBtn').addEventListener('click', () => this.backToMenu());
    
    document.getElementById('muteBtn').addEventListener('click', () => {
      audioManager.toggleMute();
    });
  },

  handleKeydown(e) {
    if (this.gameState !== 'playing') return;
    
    switch(e.key) {
      case 'ArrowLeft':
        if (this.direction !== 'RIGHT') this.direction = 'LEFT';
        break;
      case 'ArrowUp':
        if (this.direction !== 'DOWN') this.direction = 'UP';
        break;
      case 'ArrowRight':
        if (this.direction !== 'LEFT') this.direction = 'RIGHT';
        break;
      case 'ArrowDown':
        if (this.direction !== 'UP') this.direction = 'DOWN';
        break;
    }
  },

  handleTouchStart(e) {
    if (this.gameState !== 'playing') return;
    e.preventDefault();
    
    const touch = e.touches[0];
    const rect = this.canvas.getBoundingClientRect();
    this.touchStartX = touch.clientX - rect.left;
    this.touchStartY = touch.clientY - rect.top;
    
    this.showTouchIndicator(touch.clientX, touch.clientY);
  },

  handleTouchMove(e) {
    if (this.gameState !== 'playing') return;
    e.preventDefault();
  },

  handleTouchEnd(e) {
    if (this.gameState !== 'playing') return;
    e.preventDefault();
    
    const touch = e.changedTouches[0];
    const rect = this.canvas.getBoundingClientRect();
    this.touchEndX = touch.clientX - rect.left;
    this.touchEndY = touch.clientY - rect.top;
    
    this.handleSwipe();
  },

  handleMouseDown(e) {
    if (this.gameState !== 'playing') return;
    
    const rect = this.canvas.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const clickY = e.clientY - rect.top;
    
    const snakeHeadX = this.snake[0].x + this.box / 2;
    const snakeHeadY = this.snake[0].y + this.box / 2;
    
    const deltaX = clickX - snakeHeadX;
    const deltaY = clickY - snakeHeadY;
    
    if (Math.abs(deltaX) > Math.abs(deltaY)) {
      if (deltaX > 0 && this.direction !== 'LEFT') {
        this.direction = 'RIGHT';
      } else if (deltaX < 0 && this.direction !== 'RIGHT') {
        this.direction = 'LEFT';
      }
    } else {
      if (deltaY > 0 && this.direction !== 'UP') {
        this.direction = 'DOWN';
      } else if (deltaY < 0 && this.direction !== 'DOWN') {
        this.direction = 'UP';
      }
    }
    
    this.showTouchIndicator(e.clientX, e.clientY);
  },

  handleSwipe() {
    const deltaX = this.touchEndX - this.touchStartX;
    const deltaY = this.touchEndY - this.touchStartY;
    
    const absDeltaX = Math.abs(deltaX);
    const absDeltaY = Math.abs(deltaY);
    
    if (Math.max(absDeltaX, absDeltaY) < this.minSwipeDistance) {
      return;
    }
    
    if (absDeltaX > absDeltaY) {
      if (deltaX > 0 && this.direction !== 'LEFT') {
        this.direction = 'RIGHT';
      } else if (deltaX < 0 && this.direction !== 'RIGHT') {
        this.direction = 'LEFT';
      }
    } else {
      if (deltaY > 0 && this.direction !== 'UP') {
        this.direction = 'DOWN';
      } else if (deltaY < 0 && this.direction !== 'DOWN') {
        this.direction = 'UP';
      }
    }
  },

  showTouchIndicator(clientX, clientY) {
    const indicator = document.createElement('div');
    indicator.className = 'touch-indicator';
    indicator.style.left = clientX + 'px';
    indicator.style.top = clientY + 'px';
    document.body.appendChild(indicator);
    
    setTimeout(() => {
      indicator.remove();
    }, 500);
    
    if (navigator.vibrate) {
      navigator.vibrate(10);
    }
  },

  assignColorsToElements() {
    this.elementColorMap = {};
    const allElements = elements[this.selectedCategory];
    
    allElements.forEach((el, index) => {
      this.elementColorMap[el.sim] = this.gameColors[index % this.gameColors.length];
    });
  },

  getElementColor(elementSim) {
    return this.elementColorMap[elementSim] || this.gameColors[0];
  },

  startGame() {
    this.playerName = document.getElementById('playerNameInput').value.trim() || 'An√≥nimo';
    this.selectedCategory = document.getElementById('categorySelect').value;
    
    this.gameState = 'playing';
    this.snake = [{x: 9 * this.box, y: 10 * this.box}];
    this.direction = null;
    this.score = 0;
    this.lives = 3;
    this.availableElements = [...elements[this.selectedCategory]];
    this.eatenElements = [];
    this.lastElement = null;
    this.deathCause = 'Colisi√≥n';
    
    this.assignColorsToElements();
    
    this.setTargetElement();
    this.updateUI();
    this.updateBanner(); 
    this.renderPeriodicTable();
    this.placeFood();
    
    document.getElementById('menuScreen').classList.add('hidden');
    document.getElementById('gameContainer').style.display = 'flex';
    
    audioManager.playSuccess();
    audioManager.playBackgroundMusic();
    
    if (this.gameInterval) clearInterval(this.gameInterval);
    this.gameInterval = setInterval(() => this.draw(), 150);
  },

  retryGame() {
    document.getElementById('gameOverScreen').classList.add('hidden');
    document.getElementById('winScreen').classList.add('hidden');
    this.startGame();
  },

  backToMenu() {
    this.gameState = 'menu';
    document.getElementById('menuScreen').classList.remove('hidden');
    document.getElementById('gameOverScreen').classList.add('hidden');
    document.getElementById('winScreen').classList.add('hidden');
    document.getElementById('gameContainer').style.display = 'none';
    
    audioManager.stopBackgroundMusic();
    audioManager.playMenuMusic();
    
    if (this.gameInterval) clearInterval(this.gameInterval);
    
    if (this.ctx) {
      this.ctx.fillStyle = '#111827';
      this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
    }
  },

  setTargetElement() {
    if (this.availableElements.length === 0) {
      this.targetElement = null;
      return;
    }
    const idx = Math.floor(Math.random() * this.availableElements.length);
    this.targetElement = this.availableElements[idx];
    this.updateTargetDisplay();
    this.updateBanner(); 
  },

  updateBanner() {
    const bannerElement = document.getElementById('bannerElement');
    if (!this.targetElement) {
      bannerElement.textContent = '‚úì COMPLETADO';
      return;
    }
    bannerElement.textContent = this.targetElement.nombre.toUpperCase();
  },

  updateTargetDisplay() {
    if (!this.targetElement) {
      document.getElementById('targetElementDisplay').innerHTML = `
        <span class="target-sim">‚úì</span>
        <span class="target-name">¬°Completado!</span>
      `;
      return;
    }

    document.getElementById('targetElementDisplay').innerHTML = `
      <span class="target-sim">${this.targetElement.sim}</span>
      <span class="target-name">${this.targetElement.nombre}</span>
      <span class="target-valencia">Valencia: ${this.targetElement.valencia}</span>
    `;
  },

  renderPeriodicTable() {
    const table = document.getElementById('periodicTable');
    table.innerHTML = '';
    
    const allElements = elements[this.selectedCategory];
    
    allElements.forEach(el => {
      const cell = document.createElement('div');
      cell.className = 'element-cell';
      cell.textContent = el.nombre;
      cell.title = `${el.sim} - ${el.nombre} (${el.valencia})`;
      
      cell.style.backgroundColor = this.getElementColor(el.sim);
      
      if (this.eatenElements.some(e => e.sim === el.sim)) {
        cell.classList.add('eaten');
      }
      
      if (this.targetElement && el.sim === this.targetElement.sim) {
        cell.classList.add('current');
      }
      
      table.appendChild(cell);
    });
  },

  showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.textContent = message;
    document.body.appendChild(errorDiv);
    
    setTimeout(() => {
      errorDiv.remove();
    }, 1500);
  },

  placeFood() {
    this.foodItems = [];
    
    if (this.availableElements.length === 0) {
      this.endGame('win');
      return;
    }
    
    const gridWidth = Math.floor(this.canvas.width / this.box);
    const gridHeight = Math.floor(this.canvas.height / this.box);
    
    const allPositions = [];
    for (let gx = 0; gx < gridWidth; gx++) {
      for (let gy = 0; gy < gridHeight; gy++) {
        const x = gx * this.box;
        const y = gy * this.box;
        if (!this.isOnSnake(x, y)) {
          allPositions.push({x, y});
        }
      }
    }
    
    for (let i = allPositions.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [allPositions[i], allPositions[j]] = [allPositions[j], allPositions[i]];
    }
    
    const numFoods = Math.min(12, allPositions.length);
    
    const targetCount = Math.min(3, numFoods, allPositions.length);
    for (let i = 0; i < targetCount; i++) {
      this.foodItems.push({
        ...this.targetElement,
        x: allPositions[i].x,
        y: allPositions[i].y
      });
    }
    
    for (let i = targetCount; i < numFoods; i++) {
      const allCategoryElements = elements[this.selectedCategory];
      const randomIdx = Math.floor(Math.random() * allCategoryElements.length);
      const element = { ...allCategoryElements[randomIdx] };
      
      this.foodItems.push({
        ...element,
        x: allPositions[i].x,
        y: allPositions[i].y
      });
    }
  },

  isOnSnake(x, y) {
    for (let segment of this.snake) {
      if (segment.x === x && segment.y === y) {
        return true;
      }
    }
    return false;
  },

  draw() {
    if (!this.ctx) return;
    
    this.ctx.fillStyle = '#111827';
    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
    
    for (let i = 0; i < this.snake.length; i++) {
      this.ctx.fillStyle = i === 0 ? '#10b981' : '#059669';
      this.ctx.fillRect(this.snake[i].x, this.snake[i].y, this.box, this.box);
      this.ctx.strokeStyle = '#111827';
      this.ctx.strokeRect(this.snake[i].x, this.snake[i].y, this.box, this.box);
    }
    
    this.foodItems.forEach(food => {
      const isTarget = food.sim === this.targetElement.sim;
      
      if (isTarget) {
        this.ctx.fillStyle = '#fbbf24';
      } else {
        this.ctx.fillStyle = this.getElementColor(food.sim);
      }
      this.ctx.fillRect(food.x, food.y, this.box, this.box);
      
      this.ctx.fillStyle = isTarget ? '#000' : '#fff';
      this.ctx.font = 'bold 14px Arial';
      this.ctx.textAlign = 'center';
      this.ctx.fillText(food.sim, food.x + this.box/2, food.y + this.box/2 + 5);
    });
    
    if (!this.direction) return;
    
    let snakeX = this.snake[0].x;
    let snakeY = this.snake[0].y;
    
    if (this.direction === 'LEFT') snakeX -= this.box;
    if (this.direction === 'UP') snakeY -= this.box;
    if (this.direction === 'RIGHT') snakeX += this.box;
    if (this.direction === 'DOWN') snakeY += this.box;
    
    let ateFood = false;
    
    for (let i = 0; i < this.foodItems.length; i++) {
      if (snakeX === this.foodItems[i].x && snakeY === this.foodItems[i].y) {
        const eatenFood = this.foodItems[i];
        
        if (eatenFood.sim === this.targetElement.sim) {
          audioManager.speakElement(eatenFood, true);
          
          this.score += 10;
          this.lastElement = { ...eatenFood };
          this.eatenElements.push({ ...eatenFood });
          this.availableElements = this.availableElements.filter(e => e.sim !== eatenFood.sim);
          
          if (this.availableElements.length === 0) {
            this.endGame('win');
            return;
          }
          
          this.setTargetElement();
          this.renderPeriodicTable();
          
          this.foodItems.splice(i, 1);
          
          this.addNewFoodItem();
          this.ensureTargetElementsAvailable();
          
          ateFood = true;
          this.updateUI();
        } else {
          this.showError(`‚ùå ERROR: Debes comer ${this.targetElement.sim} (${this.targetElement.nombre})`);
          audioManager.speakElement(eatenFood, false);
          
          this.lives--;
          this.deathCause = `Elemento Incorrecto: ${eatenFood.sim}`;
          this.updateUI();
          
          this.foodItems.splice(i, 1);
          this.addNewFoodItem();
          this.ensureTargetElementsAvailable();
          
          if (this.lives <= 0) {
            this.endGame('gameover');
            return;
          } else {
            this.snake = [{ x: 9 * this.box, y: 10 * this.box }];
            this.direction = null;
            return;
          }
        }
        break;
      }
    }
    
    const newHead = { x: snakeX, y: snakeY };
    
    if (snakeX < 0 || snakeY < 0 || 
        snakeX >= this.canvas.width || snakeY >= this.canvas.height || 
        this.collision(newHead, this.snake)) {
      this.lives--;
      
      audioManager.playError();
      
      if (snakeX < 0 || snakeX >= this.canvas.width) {
        this.deathCause = 'Choque con Pared Lateral';
      } else if (snakeY < 0 || snakeY >= this.canvas.height) {
        this.deathCause = 'Choque con Pared Superior/Inferior';
      } else {
        this.deathCause = 'Auto-Colisi√≥n';
      }
      
      this.updateUI();
      
      if (this.lives <= 0) {
        this.endGame('gameover');
        return;
      } else {
        this.snake = [{ x: 9 * this.box, y: 10 * this.box }];
        this.direction = null;
        return;
      }
    }
    
    this.snake.unshift(newHead);
    
    if (!ateFood) {
      this.snake.pop();
    }
  },

  addNewFoodItem() {
    if (this.foodItems.length >= 12) return;
    
    const gridWidth = Math.floor(this.canvas.width / this.box);
    const gridHeight = Math.floor(this.canvas.height / this.box);
    
    const availablePositions = [];
    for (let gx = 0; gx < gridWidth; gx++) {
      for (let gy = 0; gy < gridHeight; gy++) {
        const x = gx * this.box;
        const y = gy * this.box;
        if (!this.isPositionOccupied(x, y)) {
          availablePositions.push({x, y});
        }
      }
    }
    
    if (availablePositions.length === 0) return;
    
    const randomPosIdx = Math.floor(Math.random() * availablePositions.length);
    const {x, y} = availablePositions[randomPosIdx];
    
    const currentTargetCount = this.foodItems.filter(f => f.sim === this.targetElement.sim).length;
    
    const shouldBeTarget = this.targetElement && 
                          (currentTargetCount === 0 || 
                           (currentTargetCount < 3 && Math.random() < 0.7));
    let element;
    
    if (shouldBeTarget) {
      element = { ...this.targetElement };
    } else {
      const allCategoryElements = elements[this.selectedCategory];
      const randomIdx = Math.floor(Math.random() * allCategoryElements.length);
      element = { ...allCategoryElements[randomIdx] };
    }
    
    this.foodItems.push({
      ...element,
      x: x,
      y: y
    });
  },

  isPositionOccupied(x, y) {
    if (this.isOnSnake(x, y)) return true;
    
    for (let food of this.foodItems) {
      if (food.x === x && food.y === y) return true;
    }
    
    return false;
  },

  ensureTargetElementsAvailable() {
    if (!this.targetElement) return;
    
    const currentTargetCount = this.foodItems.filter(f => f.sim === this.targetElement.sim).length;
    
    if (currentTargetCount === 0) {
      const gridWidth = Math.floor(this.canvas.width / this.box);
      const gridHeight = Math.floor(this.canvas.height / this.box);
      
      const availablePositions = [];
      for (let gx = 0; gx < gridWidth; gx++) {
        for (let gy = 0; gy < gridHeight; gy++) {
          const x = gx * this.box;
          const y = gy * this.box;
          if (!this.isPositionOccupied(x, y)) {
            availablePositions.push({x, y});
          }
        }
      }
      
      if (availablePositions.length > 0) {
        const randomPosIdx = Math.floor(Math.random() * availablePositions.length);
        const {x, y} = availablePositions[randomPosIdx];
        
        this.foodItems.push({
          ...this.targetElement,
          x: x,
          y: y
        });
        
        console.log('üéØ Elemento objetivo agregado de emergencia');
      }
    }
    
    if (currentTargetCount < 3 && this.foodItems.length < 12) {
      const needed = Math.min(3 - currentTargetCount, 12 - this.foodItems.length);
      for (let i = 0; i < needed; i++) {
        const gridWidth = Math.floor(this.canvas.width / this.box);
        const gridHeight = Math.floor(this.canvas.height / this.box);
        
        const availablePositions = [];
        for (let gx = 0; gx < gridWidth; gx++) {
          for (let gy = 0; gy < gridHeight; gy++) {
            const x = gx * this.box;
            const y = gy * this.box;
            if (!this.isPositionOccupied(x, y)) {
              availablePositions.push({x, y});
            }
          }
        }
        
        if (availablePositions.length === 0) break;
        
        const randomPosIdx = Math.floor(Math.random() * availablePositions.length);
        const {x, y} = availablePositions[randomPosIdx];
        
        this.foodItems.push({
          ...this.targetElement,
          x: x,
          y: y
        });
      }
    }
  },

  collision(head, array) {
    for (let i = 0; i < array.length; i++) {
      if (head.x === array[i].x && head.y === array[i].y) {
        return true;
      }
    }
    return false;
  },

  getElementColorForBadge(element) {
    if (elements.noMetales.some(e => e.sim === element.sim)) return 'nometal';
    if (elements.anfoteros.some(e => e.sim === element.sim)) return 'anfotero';
    return 'metal';
  },

  updateUI() {
    document.getElementById('playerDisplay').textContent = this.playerName;
    document.getElementById('categoryDisplay').textContent = this.selectedCategory;
    document.getElementById('scoreDisplay').textContent = this.score;
    document.getElementById('livesDisplay').textContent = this.lives;
    document.getElementById('remainingDisplay').textContent = this.availableElements.length;
    
    const lastElDisplay = document.getElementById('lastElementDisplay');
    if (this.lastElement) {
      const colorClass = this.getElementColorForBadge(this.lastElement);
      const badgeClass = colorClass === 'metal' ? 'badge-metal' : 
                         colorClass === 'nometal' ? 'badge-nometal' : 'badge-anfotero';
      lastElDisplay.innerHTML = `<span class="badge ${badgeClass}">${this.lastElement.sim} (${this.lastElement.valencia})</span>`;
    } else {
     lastElDisplay.innerHTML = '<span style="color: #9ca3af;">Ninguno</span>';
    }
  },

  endGame(state) {
    clearInterval(this.gameInterval);
    audioManager.stopBackgroundMusic();
    this.gameState = state;
    
    if (state === 'gameover') {
      audioManager.playGameOver();
      
      document.getElementById('finalScore').textContent = this.score;
      document.getElementById('elementsEaten').textContent = this.eatenElements.length;
      document.getElementById('deathCause').textContent = this.deathCause;
      
      const messages = [
        '"En qu√≠mica, incluso los mejores cometen errores... ¬°pero siempre hay una segunda oportunidad!"',
        '"La tabla peri√≥dica tiene 118 elementos, ¬°pero solo necesitas paciencia para dominarlos todos!"',
        '"Como dijo Marie Curie: el fracaso es solo una oportunidad para empezar de nuevo con m√°s inteligencia."',
        '"¬°No te rindas! Hasta los enlaces m√°s d√©biles pueden formar mol√©culas incre√≠bles."',
        '"Recuerda: incluso los √°tomos necesitan varios intentos para encontrar la configuraci√≥n perfecta."'
      ];
      const randomMessage = messages[Math.floor(Math.random() * messages.length)];
      document.getElementById('gameOverMessage').textContent = randomMessage;
      
      document.getElementById('gameOverScreen').classList.remove('hidden');
    } else if (state === 'win') {
      audioManager.playVictory();
      
      document.getElementById('winScore').textContent = this.score;
      document.getElementById('winScreen').classList.remove('hidden');
    }
  },

  resetGame() {
    this.gameState = 'menu';
    document.getElementById('menuScreen').classList.remove('hidden');
    document.getElementById('gameOverScreen').classList.add('hidden');
    document.getElementById('winScreen').classList.add('hidden');
    
    audioManager.stopBackgroundMusic();
    audioManager.playMenuMusic();

    if (this.gameInterval) clearInterval(this.gameInterval);
    
    if (this.ctx) {
      this.ctx.fillStyle = '#111827';
      this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
    }
  }
};

window.addEventListener('DOMContentLoaded', () => {
  game.init();
  
  document.getElementById('muteBtn').addEventListener('click', () => {
    audioManager.toggleMute();
  });
});
</script>
</body>

</html>
